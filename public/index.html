<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TAKA ALLIANCE — GoldRain (Firebase Realtime READY)</title>

<style>
  :root{ --gold:#ffd700; --gold-soft:#ffde6b; --panel:#0e0d0a; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#000;color:var(--gold);font-family:Poppins,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden;}
  canvas#goldRain{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:1;filter:drop-shadow(0 0 6px rgba(255,215,0,.65));}
  header{position:relative;z-index:5;text-align:center;padding:24px 16px 8px;}
  header h1{margin:0;font-weight:800;letter-spacing:.06em;color:var(--gold-soft);text-shadow:0 0 18px rgba(255,215,0,.55),0 0 40px rgba(255,200,0,.25);}
  header p{margin:6px 0 0;color:#d8bf66;opacity:.85;font-size:.95rem;}
  .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:14px 10px 8px;position:relative;z-index:5;}
  .btn{background:rgba(255,215,0,.10);border:1px solid rgba(255,215,0,.45);color:var(--gold-soft);font-weight:600;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s ease;box-shadow:0 0 12px rgba(255,215,0,.20) inset,0 0 6px rgba(255,215,0,.18);}
  .btn:hover{background:rgba(255,215,0,.28);transform:translateY(-2px);}
  .panel{position:relative;z-index:4;margin:10px auto 22px;width:min(1200px,96vw);background:linear-gradient(180deg,rgba(14,13,10,.96),rgba(8,7,5,.96));border:1px solid rgba(255,215,0,.20);border-radius:18px;box-shadow:0 0 0 1px rgba(255,215,0,.06) inset,0 40px 120px rgba(0,0,0,.6),0 0 60px rgba(255,215,0,.18);padding:18px 14px 20px;}
  #viewer{width:100%;height:72vh;border:1px solid rgba(255,215,0,.28);border-radius:14px;background:rgba(12,11,9,.98);box-shadow:inset 0 0 24px rgba(0,0,0,.55);}
  footer{position:fixed;bottom:8px;width:100%;text-align:center;z-index:5;color:#d8bf66;font-size:.9rem;}
  #loginOverlay{position:fixed;inset:0;display:grid;place-items:center;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.80));backdrop-filter:saturate(120%) blur(2px);}
  #loginCard{width:min(420px,92vw);padding:22px 20px 18px;border-radius:16px;background:linear-gradient(180deg,#14100a,#0f0d08);border:1px solid rgba(255,215,0,.18);color:#ffe8a6;box-shadow:0 26px 60px rgba(0,0,0,.65),0 0 32px rgba(255,210,0,.14) inset;}
  #loginCard h2{margin:0 0 6px;color:var(--gold-soft);text-shadow:0 0 14px rgba(255,215,0,.35);} #loginCard p{margin:2px 0 12px;color:#d9c88f;font-size:.95rem}
  #loginCard input{width:100%;padding:12px 12px;margin:8px 0;border-radius:12px;background:#0e0c05;color:#fff9e8;border:1px solid #3b2a10;outline:none;}
  #loginCard .btn{width:100%;padding:12px;border-radius:12px;margin-top:6px}
  #loginStatus{min-height:18px;color:#ffb4b4;margin-top:8px;font-size:.9rem;text-align:center}
  body.locked > *:not(#loginOverlay){display:none !important;}
</style>
</head>
<body class="locked">
  <canvas id="goldRain"></canvas>
  <header>
    <h1>TAKA ALLIANCE</h1>
    <p>GoldRain Master Edition Dashboard</p>
  </header>

  <div class="nav">
    <button class="btn" onclick="loadEncrypted('instagram')">Instagram</button>
    <button class="btn" onclick="loadEncrypted('linkedin')">LinkedIn</button>
    <button class="btn" onclick="loadEncrypted('tiktok')">TikTok</button>
    <button class="btn" onclick="loadEncrypted('threads')">Threads</button>
    <button class="btn" onclick="loadEncrypted('reddit')">Reddit</button>
    <button class="btn" onclick="loadEncrypted('medium')">Medium</button>
    <button class="btn" onclick="loadEncrypted('x')">X (Twitter)</button>
    <button class="btn" onclick="loadEncrypted('youtube')">YouTube</button>
  </div>

  <div class="panel">
    <!-- IMPORTANT: no sandbox so scripts & modules inside .enc can run -->
    <iframe id="viewer" allow="fullscreen; clipboard-read; clipboard-write; autoplay; encrypted-media" referrerpolicy="no-referrer"></iframe>
  </div>

  <footer>© 2025 TAKA ALLIANCE — GoldRain Master Edition</footer>

  <!-- Login overlay -->
  <div id="loginOverlay" aria-hidden="false">
    <div id="loginCard" role="dialog" aria-label="CK44 Secure Login">
      <h2>Secure Access</h2>
      <p>Masukkan kredensial untuk membuka dashboard.</p>
      <input id="user" placeholder="username" autocomplete="username" />
      <input id="pass" placeholder="password" type="password" autocomplete="current-password" />
      <div id="loginStatus"></div>
      <button id="loginBtn" class="btn">Unlock Dashboard</button>
    </div>
  </div>

<script>
/* ===================== Anti-inspect ===================== */
window.addEventListener('contextmenu', e=>e.preventDefault());
window.addEventListener('keydown', e=>{
  const k=e.key.toUpperCase();
  if(k==='F12') e.preventDefault();
  if(e.ctrlKey && e.shiftKey && ['I','J','C'].includes(k)) e.preventDefault();
  if(e.ctrlKey && ['U','S','P'].includes(k)) e.preventDefault();
}, true);

/* ===================== Login ===================== */
const USER='martinganteng', PASS='martinterkece', EXP_MIN=30;
function valid(){ const t=Number(localStorage.getItem('ck44_exp')||0); return Date.now()<t; }
function setOK(){ localStorage.setItem('ck44_exp', String(Date.now()+EXP_MIN*60*1000)); }
function lock(msg){ const o=document.getElementById('loginOverlay'); o.style.display='grid'; o.setAttribute('aria-hidden','false'); document.body.classList.add('locked'); if(msg) document.getElementById('loginStatus').textContent=msg; }
function unlock(){ document.getElementById('loginOverlay').style.display='none'; document.body.classList.remove('locked'); document.getElementById('loginStatus').textContent=''; }
document.getElementById('loginBtn').addEventListener('click',()=>{
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value;
  if(u===USER && p===PASS){ setOK(); unlock(); } else { lock('Login gagal — coba lagi.'); setTimeout(()=>document.getElementById('loginStatus').textContent='',2200); }
});
document.getElementById('pass').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('loginBtn').click(); });
document.addEventListener('DOMContentLoaded',()=>{ if(valid()) unlock(); else lock(''); });
setInterval(()=>{ if(!valid()) lock('Sesi habis. Login ulang.'); }, 5000);

/* ===================== GoldRain ===================== */
const rain = document.getElementById('goldRain'); const ctx=rain.getContext('2d'); let P=[];
function size(){ rain.width=innerWidth; rain.height=innerHeight; }
function seed(){ P=[]; for(let i=0;i<140;i++){ P.push({x:Math.random()*rain.width,y:Math.random()*rain.height,s:Math.random()*2+0.3,v:0.4+Math.random()*1.2}); } }
function draw(){
  ctx.clearRect(0,0,rain.width,rain.height);
  ctx.fillStyle='#ffd700';
  for(const p of P){ ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill(); p.y+=p.v; if(p.y>rain.height){ p.y=-5; p.x=Math.random()*rain.width; } }
  requestAnimationFrame(draw);
}
addEventListener('resize',()=>{ size(); seed(); });
size(); seed(); draw();

/* ===================== AES‑GCM Decrypt + Loader ===================== */
function b64ToBytes(b64){ const bin=atob(b64.trim()); const len=bin.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i); return bytes; }
async function importKey(pw,salt){
  const enc=new TextEncoder();
  const mat=await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:120000,hash:'SHA-256'}, mat, {name:'AES-GCM',length:256}, false, ['decrypt']);
}
async function decryptB64(b64){
  const buf=b64ToBytes(b64);
  const salt=buf.slice(0,16), iv=buf.slice(16,28), data=buf.slice(28, buf.length-16), tag=buf.slice(buf.length-16);
  const full=new Uint8Array(data.length+tag.length); full.set(data,0); full.set(tag,data.length);
  const key=await importKey('TAKAALLIANCE_2025', salt);
  const plain=await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, full);
  return new TextDecoder().decode(new Uint8Array(plain));
}
async function loadEncrypted(name){
  const paths=[ `/assets/planners_encrypted/${name}.enc`, `/public/assets/planners_encrypted/${name}.enc` ];
  let b64=null;
  for(const url of paths){
    try{ const r=await fetch(url); if(r.ok){ b64=await r.text(); break; } }catch(e){}
  }
  if(!b64){ alert('❌ File tidak ditemukan di /assets atau /public/assets.'); return; }
  try{
    const html=await decryptB64(b64);
    const frame=document.getElementById('viewer');
    frame.removeAttribute('sandbox');
    // prefer srcdoc to keep same-origin with blob less quirks
    frame.srcdoc = html;
    if(!('srcdoc' in frame)){ // fallback
      const blob=new Blob([html],{type:'text/html'});
      const url=URL.createObjectURL(blob);
      frame.src=url;
    }
  }catch(e){ alert('❌ Gagal mendekripsi file'); }
}

/* ===================== Parent <-> Iframe Bridge ===================== */
window.addEventListener('message', (ev)=>{
  const d = ev.data || {};
  if(d.type === 'download_csv'){
    try{
      const blob = new Blob([d.content||''], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = d.filename || 'planner.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 400);
    }catch(e){ alert('CSV download failed'); }
  }
});
</script>

<!-- ===================== Firebase (Parent-level) ===================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBmog9ZyeL6_95xTnld0SLcuy5ZycspZZo",
    authDomain: "taka-alliance.firebaseapp.com",
    databaseURL: "https://taka-alliance-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "taka-alliance",
    storageBucket: "taka-alliance.firebasestorage.app",
    messagingSenderId: "1056890285843",
    appId: "1:1056890285843:web:a840634f72548f1350f4e6",
    measurementId: "G-65ZQJ7DKHF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Bridge for child iframes that ask parent to read/write
  function cleanKey(k){ return encodeURIComponent(String(k||'').replace(/\//g,'_')); }

  window.addEventListener('message', async (ev)=>{
    const d = ev.data || {};
    // Child asks current value
    if(d.type === 'get_val' && d.key){
      const snap = await get(child(ref(db), 'bridge/' + cleanKey(d.key)));
      const v = snap.exists() ? snap.val() : (localStorage.getItem(d.key) || '0');
      ev.source?.postMessage({type:'set_val', key:d.key, value: (v===1||v==='1') ? '1':'0'}, '*');
    }
    // Child notifies update (write to Firebase + cache)
    if(d.type === 'checkbox_update' && d.key){
      const path = 'bridge/' + cleanKey(d.key);
      set(ref(db, path), d.value ? 1 : 0).catch(()=>{});
      try{ localStorage.setItem(d.key, d.value ? '1' : '0'); }catch(e){}
    }
  });

  // Optional: keep a minimal live mirror to localStorage for fast first paint
  onValue(ref(db, 'bridge'), (snap)=>{
    const obj = snap.val() || {};
    for (const [k,v] of Object.entries(obj)){
      try{ localStorage.setItem(k, (v===1||v==='1') ? '1' : '0'); }catch(e){}
    }
  });
</script>
</body>
</html>
